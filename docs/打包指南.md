# LLExtTool 打包指南

## 前置要求

- Node.js 和 npm 已安装
- 项目已成功编译
- 所有 native 模块已构建

## 打包步骤

### 1. 准备检查

运行准备脚本检查所有必需文件：

```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\prepare-package.ps1
```

该脚本会检查：
- ✅ TypeScript 编译输出
- ✅ Native 模块 (.node)
- ✅ FFmpeg DLL 文件
- ✅ Whisper DLL 文件
- ⚠️ 翻译模型（可选）
- ⚠️ 应用图标（可选）

### 2. 构建完整包

```powershell
# 构建 Windows 安装包 (NSIS) 和 ZIP
npm run package

# 或者只构建 Windows 版本
npm run package:win

# 或者只构建目录（不打包）
npm run package:dir
```

### 3. 输出位置

打包完成后，文件会输出到 `release/` 目录：

```
release/
├── LLExtTool Setup 1.0.0.exe    # NSIS 安装程序
├── LLExtTool-1.0.0-win.zip      # 绿色版 ZIP
└── win-unpacked/                 # 解压后的应用目录
```

## 打包配置说明

### 包含的文件

**应用代码：**
- `dist/` - TypeScript 编译输出
- `build/Release/*.node` - Native 模块
- `build/Release/*.dll` - 相关 DLL

**Native 库：**
- `native/ffmpeg/bin/*.dll` - FFmpeg 动态库
- `native/whisper.cpp/build/bin/Release/*.dll` - Whisper 动态库
- `native/ctranslate2/bin/*.dll` - CTranslate2 动态库（如果存在）

**模型文件（可选）：**
- `native/models/` - 翻译模型

### 排除的文件

为了减小包体积，以下文件被排除：
- `native/**/*.lib` - 静态库（编译时需要）
- `native/**/*.obj` - 目标文件
- `native/**/*.pdb` - 调试符号
- `native/whisper.cpp/build/**/*` - 构建中间文件
- `native/ctranslate2-source/**/*` - 源码
- `native/ffmpeg/bin/*.exe` - FFmpeg 命令行工具

## 常见问题

### Q: 打包失败，提示缺少文件

**A:** 运行准备脚本检查：
```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\prepare-package.ps1
```

如果缺少文件，需要重新构建：
```powershell
npm run build           # 构建 TypeScript
npx electron-rebuild    # 构建 native 模块
```

### Q: 打包后体积太大

**A:** 
1. 检查是否包含了不必要的文件（如源码、中间文件）
2. 移除不需要的模型文件
3. 使用 `package:dir` 查看实际包含的文件

当前配置已经优化，主要体积来源：
- Electron 运行时：~150MB
- FFmpeg 库：~50MB
- Whisper 库：~30MB
- 翻译模型（可选）：~300MB

### Q: 打包后运行报错找不到 DLL

**A:** 确保在 `package.json` 的 `extraResources` 中正确配置了 DLL 路径。

检查打包后的文件：
```powershell
# 解压到 release/win-unpacked 查看
npm run package:dir

# 检查 resources 目录
Get-ChildItem release/win-unpacked/resources -Recurse -Filter "*.dll"
```

### Q: 需要在安装时让用户选择是否安装模型

**A:** 修改 `package.json` 中的 `nsis` 配置：

```json
"nsis": {
  "include": "scripts/installer.nsh",
  "oneClick": false
}
```

然后创建 `scripts/installer.nsh` 自定义安装脚本。

### Q: 如何添加应用图标

**A:** 
1. 准备图标文件（256x256 PNG 或 ICO 格式）
2. 放置到 `assets/icon.ico`
3. 确保 `package.json` 中配置了：
   ```json
   "win": {
     "icon": "assets/icon.ico"
   }
   ```

### Q: 如何生成便携版（绿色版）

**A:** 已配置 ZIP 输出：
```powershell
npm run package
```

会同时生成：
- NSIS 安装包（带卸载程序）
- ZIP 压缩包（解压即用）

## 高级配置

### 自动更新

如果需要自动更新功能，添加：

```json
"publish": {
  "provider": "github",
  "owner": "yuthelastleaf",
  "repo": "LLExtTool"
}
```

### 代码签名

添加代码签名（需要证书）：

```json
"win": {
  "certificateFile": "path/to/certificate.pfx",
  "certificatePassword": "password",
  "signingHashAlgorithms": ["sha256"]
}
```

### 多语言安装程序

```json
"nsis": {
  "language": ["en_US", "zh_CN", "ja_JP"]
}
```

## 发布流程

1. **更新版本号**
   ```powershell
   # 更新 package.json 中的 version
   npm version patch  # 1.0.0 -> 1.0.1
   npm version minor  # 1.0.0 -> 1.1.0
   npm version major  # 1.0.0 -> 2.0.0
   ```

2. **构建发布包**
   ```powershell
   npm run clean
   npm run build
   npx electron-rebuild
   npm run package
   ```

3. **测试安装包**
   - 运行 `release/LLExtTool Setup 1.0.0.exe`
   - 测试安装、运行、卸载

4. **发布**
   - 上传到 GitHub Releases
   - 或者部署到服务器

## 持续集成（CI）

在 `.github/workflows/build.yml` 中配置自动打包：

```yaml
name: Build
on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - run: npm install
      - run: npm run build
      - run: npx electron-rebuild
      - run: npm run package
      
      - uses: actions/upload-artifact@v3
        with:
          name: windows-installer
          path: release/*.exe
```

## 调试打包问题

启用详细日志：
```powershell
$env:DEBUG = "electron-builder"
npm run package
```

查看打包内容：
```powershell
# 使用 asar 工具查看打包后的 app.asar
npm install -g asar
asar list release/win-unpacked/resources/app.asar
asar extract release/win-unpacked/resources/app.asar extracted/
```

## 优化建议

1. **启用压缩**：已默认启用 ASAR 打包
2. **延迟加载模型**：不要预装大模型，让用户首次运行时下载
3. **增量更新**：使用 electron-updater 实现增量更新
4. **Web 安装器**：创建轻量级在线安装器，按需下载组件
