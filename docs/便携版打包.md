# 便携版打包指南

## 打包配置说明

当前配置会生成单个可执行文件（便携版），特点：

- ✅ 单个 `.exe` 文件
- ✅ 无需安装，双击即用
- ✅ 所有配置和模型存储在用户数据目录
- ✅ 不包含大模型文件（首次运行时下载）

## 快速打包

```powershell
# 清理缓存（解决符号链接权限问题）
Remove-Item -Path "$env:LOCALAPPDATA\electron-builder\Cache" -Recurse -Force

# 以管理员身份运行（推荐）或启用开发者模式
# 然后执行打包
npm run package
```

## 输出文件

```
release/
└── LLExtTool-1.0.0.exe    # 便携版可执行文件（~200MB）
```

## 模型文件管理

### 用户数据目录结构

```
C:\Users\<用户名>\AppData\Roaming\LLExtTool\
├── config.json          # 应用配置
└── models/              # 模型文件目录
    ├── ggml-large-v2-f16.bin         # Whisper 模型（~3GB，首次下载）
    └── opus-mt-ja-zh-ct2/            # 翻译模型（可选，~300MB）
        ├── model.bin
        ├── config.json
        └── shared_vocabulary.json
```

### 模型下载方式

**方式 1：应用内下载（推荐）**

用户首次运行时，应用会检测缺失的模型并提示下载：
1. 应用启动时自动检测
2. 显示模型管理界面
3. 一键下载所需模型
4. 显示下载进度

**方式 2：手动放置**

用户也可以手动下载模型并放置到：
`C:\Users\<用户名>\AppData\Roaming\LLExtTool\models\`

### 首次启动流程

```
1. 启动应用
2. 检测到缺少 Whisper 模型
3. 弹出模型管理对话框：
   ┌─────────────────────────────────────┐
   │  需要下载语音识别模型              │
   │                                     │
   │  ☐ Whisper Large v2 (推荐) - 3GB  │
   │     最高质量的语音识别模型          │
   │                                     │
   │  ☐ 日译中翻译模型 (可选) - 300MB   │
   │     支持日语到中文翻译              │
   │                                     │
   │  [下载选中模型]  [稍后下载]         │
   └─────────────────────────────────────┘
4. 用户选择下载
5. 显示下载进度
6. 下载完成后自动加载模型
```

## 打包优化

### 减小包体积

当前配置已排除：
- ❌ 模型文件（3GB+）
- ❌ 源码（.cpp, .h）
- ❌ 编译中间文件（.obj, .pdb）
- ❌ 静态库（.lib）

仅包含：
- ✅ 应用代码
- ✅ Native 模块（.node）
- ✅ 运行时 DLL
- ✅ Electron 运行时

预计大小：~200MB（压缩后约 150MB）

### 进一步优化

如果需要更小的体积，可以：

1. **使用 ASAR 压缩**（已启用）
2. **使用 7-Zip 打包**：
   ```powershell
   npm run package
   7z a -mx9 LLExtTool-portable.7z release/LLExtTool-1.0.0.exe
   ```
3. **使用在线安装器**（高级）：
   - 制作轻量级启动器（<5MB）
   - 首次运行时下载主程序和依赖

## 完整打包流程

```powershell
# 1. 清理旧构建
npm run clean
Remove-Item -Path "release" -Recurse -Force -ErrorAction SilentlyContinue

# 2. 清理 electron-builder 缓存
Remove-Item -Path "$env:LOCALAPPDATA\electron-builder\Cache" -Recurse -Force -ErrorAction SilentlyContinue

# 3. 编译 TypeScript
npm run build

# 4. 重新编译 native 模块
npx electron-rebuild

# 5. 检查准备情况
powershell -ExecutionPolicy Bypass -File .\scripts\prepare-package.ps1

# 6. 以管理员身份运行打包
npm run package
```

## 测试便携版

```powershell
# 运行生成的便携版
.\release\LLExtTool-1.0.0.exe

# 测试要点：
# ✓ 应用正常启动
# ✓ 显示模型下载提示
# ✓ 模型下载功能正常
# ✓ 下载后能正常使用
# ✓ 配置保存正常
# ✓ 重新启动后配置保留
```

## 发布流程

### 准备发布文件

```powershell
# 1. 更新版本号
npm version 1.0.1

# 2. 打包
npm run package

# 3. 创建发布包
$version = (Get-Content package.json | ConvertFrom-Json).version
Compress-Archive -Path "release\LLExtTool-$version.exe" -DestinationPath "LLExtTool-v$version-portable-win-x64.zip"
```

### 创建 README

在发布时包含使用说明：

```markdown
# LLExtTool v1.0.0 便携版

## 使用方法

1. 下载 LLExtTool-1.0.0.exe
2. 双击运行（无需安装）
3. 首次运行会提示下载模型文件（约 3GB）
4. 等待模型下载完成
5. 开始使用

## 系统要求

- Windows 10/11 (64位)
- 8GB+ 内存（推荐 16GB）
- 5GB+ 可用磁盘空间
- （可选）NVIDIA GPU + CUDA 12.x（用于 GPU 加速）

## 模型下载

首次运行需要下载语音识别模型（约 3GB）：
- Whisper Large v2：最高质量的多语言语音识别
- 日译中翻译模型（可选）：支持日语字幕翻译

模型文件存储在：
`C:\Users\<用户名>\AppData\Roaming\LLExtTool\models\`

## 卸载

1. 删除 LLExtTool-1.0.0.exe
2. 删除用户数据目录：
   `C:\Users\<用户名>\AppData\Roaming\LLExtTool\`
```

### 发布到 GitHub Releases

```powershell
# 使用 GitHub CLI
gh release create v1.0.0 `
  .\release\LLExtTool-1.0.0.exe `
  --title "LLExtTool v1.0.0" `
  --notes "首个正式版本，便携版无需安装"
```

## 常见问题

### Q: 为什么包体积这么大？
A: Electron 应用包含完整的 Chromium 和 Node.js 运行时，加上 FFmpeg 等库，基础体积约 150-200MB。模型文件不包含在内。

### Q: 用户如何获取模型？
A: 首次运行时应用会自动提示下载。用户也可以手动下载放到指定目录。

### Q: 如何支持离线使用？
A: 可以制作包含模型的完整包（4GB+），或提供离线模型下载包。

### Q: 能否制作安装版？
A: 可以，运行 `npm run package:nsis` 生成 NSIS 安装包。

### Q: 如何添加自动更新？
A: 使用 electron-updater，配置更新服务器，添加检查更新功能。
