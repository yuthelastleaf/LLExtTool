# 三段式编辑器问题修复说明

## 修复的问题

### ✅ 问题 1: 音频波形不显示
**原因**：
- 没有加载音频文件到 AudioBuffer
- 提取音频后没有保存路径供后续使用
- 没有在处理完成后调用波形加载函数

**解决方案**：
1. 添加 `currentAudioPath` 全局变量保存音频文件路径
2. 在提取音频后保存路径：`currentAudioPath = audioPath`
3. 在 `displaySubtitles()` 之后调用 `loadAudioForWaveform()`
4. 修复 `loadAudioForWaveform()` 使用 Node.js `fs.readFileSync()` 读取文件
5. 音频解码成功后自动绘制当前段落的波形

**测试方法**：
1. 选择视频文件
2. 点击"开始处理"
3. 处理完成后，顶部应显示蓝色音频波形

### ✅ 问题 2: 左右切换按钮无反应
**原因**：
- 事件监听器绑定时机问题
- 按钮元素可能尚未加载到 DOM
- 缺少调试日志无法定位问题

**解决方案**：
1. 在 `initNewEditor()` 中添加元素检查日志
2. 添加空值检查：`if (prevSegmentBtn) { ... }`
3. 添加点击事件日志：`console.log('[Editor] Previous segment clicked')`
4. 切换段落时同时更新角色列表：调用 `renderRoles()`
5. 确保 `init()` 完成后再调用 `initNewEditor()`

**测试方法**：
1. 处理视频后生成字幕
2. 点击 ◀️ 按钮（应切换到上一段）
3. 点击 ▶️ 按钮（应切换到下一段）
4. 查看控制台日志确认事件触发

### ✅ 问题 3: 添加说话人无反应
**原因**：
- 按钮点击事件未正确绑定
- 缺少事件触发日志

**解决方案**：
1. 添加元素检查：`if (addRoleBtn) { ... }`
2. 添加点击事件日志：`console.log('[Editor] Add role clicked')`
3. 添加角色后输出日志：`console.log('[Editor] Role added:', name)`
4. 确保 `renderRoles()` 正确更新 DOM

**测试方法**：
1. 处理视频后生成字幕
2. 点击右下角 ➕ 按钮
3. 输入角色名称（如"角色C"）
4. 确认新角色出现在列表中

## 代码修改摘要

### 新增变量
```typescript
let currentAudioPath: string | null = null;  // 保存音频文件路径
```

### 修改的函数

#### 1. `processVideo()` - 处理视频
```typescript
// 保存音频路径
currentAudioPath = audioPath;

// 处理完成后加载音频
if (currentAudioPath) {
    await loadAudioForWaveform(currentAudioPath);
}
```

#### 2. `initNewEditor()` - 初始化编辑器
```typescript
// 添加详细日志
console.log('[Editor] Buttons found:', { ... });

// 添加空值检查
if (prevSegmentBtn) {
    prevSegmentBtn.addEventListener('click', () => {
        console.log('[Editor] Previous segment clicked');
        // ...
    });
}
```

#### 3. `loadAudioForWaveform()` - 加载音频
```typescript
// 使用 Node.js fs 读取文件（Electron 环境）
const fs = require('fs');
const fileBuffer = fs.readFileSync(audioPath);
const arrayBuffer = fileBuffer.buffer.slice(...);

// 解码后立即绘制
audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
drawWaveformForSegment(currentSegments[currentSegmentIndex]);
```

## 调试技巧

### 查看控制台日志
打开开发者工具（F12），查看以下日志：
- `[Editor] Initializing new editor...` - 编辑器初始化
- `[Editor] Buttons found: {...}` - 按钮元素检测结果
- `[Editor] Previous/Next segment clicked` - 切换按钮点击
- `[Editor] Add role clicked` - 添加角色点击
- `[Waveform] Audio loaded successfully` - 音频加载成功
- `[Waveform] Audio decoded successfully` - 音频解码成功

### 常见问题

**Q: 波形仍然不显示？**
A: 检查控制台是否有以下日志：
- `[Renderer] Audio extracted to: ...` 
- `[Waveform] Loading audio from: ...`
- `[Waveform] Audio decoded successfully`

如果没有，可能是音频文件路径问题或格式问题。

**Q: 按钮点击没反应？**
A: 查看控制台 `[Editor] Buttons found` 日志，确认按钮是否找到。
如果是 `false`，说明 HTML 结构有问题。

**Q: 添加角色后不显示？**
A: 查看 `[Editor] Role added` 日志，确认角色是否成功添加。
检查 `renderRoles()` 是否被调用。

## 测试清单

- [ ] 视频处理完成后，顶部显示蓝色音频波形
- [ ] 点击 ◀️ 按钮可以切换到上一段字幕
- [ ] 点击 ▶️ 按钮可以切换到下一段字幕
- [ ] 第一段时 ◀️ 按钮禁用（灰色）
- [ ] 最后一段时 ▶️ 按钮禁用（灰色）
- [ ] 点击 ➕ 按钮弹出输入框
- [ ] 输入角色名称后，新角色出现在列表中
- [ ] 点击角色胶囊可以分配给当前字幕段
- [ ] 切换字幕段时，角色选中状态正确更新
- [ ] 点击 👁️ 按钮可以显示/隐藏原文

## 下一步优化建议

1. **波形交互**：点击波形跳转到对应时间位置
2. **音频播放**：实现播放/暂停功能
3. **键盘快捷键**：方向键切换段落，Space 播放/暂停
4. **波形缩放**：实现 + - 按钮功能
5. **拖拽编辑**：拖拽调整字幕时间范围
6. **批量操作**：选择多个段落批量分配角色
